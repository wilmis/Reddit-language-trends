<!doctype html>

<html>

<head>
    <meta charset="utf-8">

    <title>Reddit langage analysis</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.1/d3.js"></script>
    
    <style>
        body {
            font-family: Consolas, monaco, monospace;
            height: 100vh;
        }
        
        #legends {
            position: fixed;
        }
 
        #subreddits {
            cursor: pointer;
            font-size: 24px;
            list-style-type: none;
            user-select: none;
        }
        
        #metrics {
            cursor: pointer;
            color: #777;
            font-size: 15px;
            list-style-type: none;
            user-select: none;
        }
        
        #scatter {
            background-color: #ccc;
            width: 100%;
            height: 90%; 
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);            
        }
    </style>
    
</head>

<body>
    <div id="legends">
        <ul id="subreddits"></ul>
        <hr>
        <ul id="metrics"></ul>
    </div>
    
    <svg id="scatter">
        
    </svg>

    <script type='text/javascript'>
    
        $(function(){
        
            var scatterSvg = d3.select("#scatter");
            var scatter = d3.select("#scatter").append("g");
            var timestep = 0;
            var selectedSubreddits = {};
            var metrics = [];
            var selectedMetrics = {};
            
            const colors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4',
                            '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff',
                            '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1',
                            '#000075', '#808080', '#ffffff'];
            
            function selectSubreddit(filename, subreddit){
                $(".sub_"+filename.slice(0, -5)).css("font-weight","700");
                
                for (key in selectedSubreddits){
                    deselectSubreddit(key); // Only one sub at the time.
                }
                
                selectedSubreddits[filename] = subreddit;
                
                stage = 1 + 1*filename.includes("_2analyzed_") + 2*filename.includes("_3reduced_");
                
                // Find and append metrics being used.
                if (subreddit.posts.length != 0){
                    metrics = Object.keys(subreddit.posts[0]["analyzed_data"]);
                }
                
                for (metric in metrics){
                    $("#metrics").append("<li class='met "+"sub_"+filename.slice(0,-5)+"'>"+metrics[metric]+"</li>");
                }
                
                width = $("#scatter").width();
                height = $("#scatter").height();
                
                if (stage == 3){
                    // Add points
                    var scale = 40;
                
                    scatter.selectAll("circle.sub_"+filename)
                        .data(subreddit.posts.filter(function(post){ // TODO: do this with offset to support a lot of data
                            return timestep in post.reduced_data;
                        }, function(post){
                            return post.id;
                        }))
                        .enter()
                        .append('circle')
                        .classed('sub_'+filename.slice(0,-5), true)
                        .attr('cx', function(post){
                            return post.reduced_data[timestep][0]*scale+width/2;
                        })
                        .attr('cy', function(post){
                            return post.reduced_data[timestep][1]*scale+height/2;
                        })
                        .attr('r', 0)
                        .transition()
                            .delay(function(post){
                                var x = post.reduced_data[timestep][0];
                                var y = post.reduced_data[timestep][1];
                                return Math.sqrt(x*x+y*y)*10;
                            })
                            .attr('r', 2);
                }
                
                
            }
            
            function deselectSubreddit(filename){
                $(".sub_"+filename.slice(0, -5)).css("font-weight","400"); 
                delete selectedSubreddits[filename];
                
                $("#metrics .sub_"+filename.slice(0, -5)).remove();
                
                scatter.selectAll(".sub_"+filename.slice(0,-5))
                    .transition()
                        .delay(function(post){
                            var x = post.reduced_data[timestep][0];
                            var y = post.reduced_data[timestep][1];
                            return Math.sqrt(x*x+y*y)*10;
                        })
                        .attr('r', 0)
                        .remove();
            }
            
            $(document).on("click", ".sub", function(){
                if ($(this).html() in selectedSubreddits){
                    filename = $(this).html();
                    deselectSubreddit(filename);
                }
                else {
                    $(this).css("font-weight","700");
                    filename = $(this).html();
                    getSubreddit(filename, function(subreddit){
                        selectSubreddit(filename, subreddit);
                    });
                }
            });
            
            function selectMetric(metric, element){
                element.css("font-weight", "700");
                color = colors[metrics.indexOf(metric)];
                
                selectedMetrics[metric] = color;
                element.css("color", color);
            }
            
            function deselectMetric(metric, element){
                element.css("font-weight", "400"); 
                element.css("color", "");
                delete selectedMetrics[metric];
            }
            
            $(document).on("click", ".met", function(){
                var metric = $(this).html();
                if (metric in selectedMetrics){
                    deselectMetric(metric, $(this));
                }
                else {
                    selectMetric(metric, $(this));
                }
            });
        
            function getSubreddit(subreddit, callback){
                console.log(subreddit)
                var request = new XMLHttpRequest();
                request.open('GET', '/caches/'+subreddit);
                request.onload = function() {
                    callback(JSON.parse(request.response))
                }
                request.send();
            }
    
            var request = new XMLHttpRequest();
            
            request.open('GET', '/caches/')
            request.onload = function() {
                $($.parseHTML(request.response)).find("a").each(function(index) {
                    if ($(this).text()[0] != "." && $(this).text().includes(".json")){
                        $("#subreddits").append("<li class='sub "+"sub_"+$(this).text().slice(0,-5)+"'>"+$(this).text()+"</li>");
                    }
                })

            }
            request.send();
            
                    
        })
        
    </script>

</body>

</html>